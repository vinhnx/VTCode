# Graceful Error Handling for Provider API Errors

## Issue Summary
When LLM provider errors occurred (e.g., Anthropic "credit balance is too low"), the entire application would:
1. Panic and exit instead of continuing the session
2. Display raw JSON error responses instead of friendly messages
3. Show the thinking spinner stuck on screen while displaying error

## Solution Overview
Implemented 3-part fix for graceful error handling with user-friendly error display.

---

## Part 1: Graceful Error Handling (No Panic)
**File**: `src/agent/runloop/unified/turn/session_loop.rs`

### Changes:
1. **Turn Execution Error Handling** (lines 1010-1035)
   - Wrapped `run_turn_loop()` in match block to catch errors
   - Displays error to user via `renderer.line()`
   - Returns `TurnLoopOutcome` with `Aborted` status
   - Session continues instead of exiting

2. **Turn Outcome Application Error Handling** (lines 1038-1054)
   - Wrapped `apply_turn_outcome()` in error handler
   - Gracefully handles finalization errors

3. **Session Finalization Error Handling** (lines 1064-1079)
   - Wrapped `finalize_session()` in error handler
   - Session loop continues even if finalization fails

### Safety Guarantees:
✓ No panics - uses safe patterns (`.ok()`, `let _`)
✓ No input field pollution - errors in message queue only
✓ Session continuity - allows user to continue after error
✓ Proper logging - all errors logged for debugging

---

## Part 2: Clear Spinner Before Error
**File**: `src/agent/runloop/unified/turn/session_loop.rs`

### Changes:
1. **Explicit Spinner Cleanup** (line 1028)
   - Call `handle.set_input_status(None, None)` to clear spinner from input status area
   - Spinner resides in UI status line, not message queue, so explicit clearing is required
   
2. **Clear Output Line** (line 1030)
   - Added `renderer.line_if_not_empty(MessageStyle::Output)` before error display
   - Ensures any pending output is cleared before showing error
   
Result: Spinner is completely removed from UI before error appears

---

## Part 3: User-Friendly Error Messages
**File**: `vtcode-core/src/llm/providers/anthropic.rs`

### Changes:
1. **Added `parse_error_response()` helper** (lines 1401-1434)
   - Extracts friendly message from JSON error response
   - Returns: (friendly_message, error_type, request_id)
   - Gracefully falls back to raw error if JSON parsing fails

2. **Updated Error Formatting** (lines 1000-1017)
   - Uses parsed friendly message instead of raw JSON
   - Includes HTTP status and error type as secondary info
   - Special handling for cache_control errors with helpful note

### Example Transformation:

**Before:**
```
HTTP 400: {"type":"error","error":{"type":"invalid_request_error","message":"Your credit balance is too low to access the Anthropic API. Please go to Plans & Billing to upgrade or purchase credits."},"request_id":"req_011CVU4qVSjsrimDDbjrwZdR"}
```

**After:**
```
Your credit balance is too low to access the Anthropic API. Please go to Plans & Billing to upgrade or purchase credits. (HTTP 400 - invalid_request_error)
```

---

## Test Results

✓ Build: `cargo build --release` - Success
✓ Check: `cargo check` - Success  
✓ No compilation errors or warnings
✓ Errors display gracefully without panicking
✓ Session continues after errors
✓ No spinner overlay on error messages
✓ User-friendly error messages displayed

---

## Files Modified

1. **`src/agent/runloop/unified/turn/session_loop.rs`**
   - Added error handling for turn execution, outcome application, and finalization
   - Added spinner clear before error display
   - Added imports for `TurnLoopOutcome` and `TurnLoopResult`

2. **`vtcode-core/src/llm/providers/anthropic.rs`**
   - Added `parse_error_response()` helper function
   - Updated error formatting to use friendly messages
   - Added error type and HTTP status to error context

---

## Git Commits

1. `865745f8` - fix: gracefully handle provider API errors without panicking
2. `fd74210d` - fix: clear spinner before displaying error message
3. `d1d978a1` - feat: parse and display friendly error messages from Anthropic API responses
