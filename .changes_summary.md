# Fix: Graceful Error Handling for Provider API Errors

## Issue
When an LLM provider error occurred (e.g., Anthropic "credit balance is too low"), the entire application would panic and exit instead of displaying the error gracefully in the message queue and allowing the session to continue.

## Root Cause
Errors from `run_turn_loop()`, `apply_turn_outcome()`, and `finalize_session()` were propagated up the call stack using the `?` operator, which caused the entire application to exit when reaching `main()`.

## Solution
Modified `/Users/vinhnguyenxuan/Developer/learn-by-doing/vtcode/src/agent/runloop/unified/turn/session_loop.rs` to handle errors gracefully without panicking or displaying them in the input field.

### Changes Made

1. **Turn Execution Error Handling** (lines 1010-1035)
   - Wrapped `run_turn_loop()` call in a `match` block
   - On error: logs error to tracing, displays to message queue via `renderer.line()`, continues session
   - Returns `TurnLoopOutcome` with `Aborted` status
   - Uses `let _ = renderer.line()` to prevent panics even if rendering fails

2. **Turn Outcome Application Error Handling** (lines 1038-1054)
   - Wrapped `apply_turn_outcome()` call in `if let Err(err)` block
   - On error: logs error, displays gracefully, continues session
   - Uses `.ok()` to suppress propagation

3. **Session Finalization Error Handling** (lines 1064-1079)
   - Wrapped `finalize_session()` call in `if let Err(err)` block
   - On error: logs error, displays gracefully, session loop continues
   - Uses `.ok()` to suppress propagation

### Key Safeguards

✓ **No Panics**: All error handling uses safe patterns (`.ok()`, `let _`) that never panic
✓ **No Input Field Pollution**: Errors display in message queue via `renderer.line()`, not in input field
✓ **Session Continuity**: Errors result in `TurnLoopResult::Aborted`, allowing session to continue
✓ **Proper Logging**: All errors logged to trace log for debugging
✓ **Type Safety**: Proper imports of `TurnLoopOutcome` and `TurnLoopResult` to avoid compilation errors

### Error Display Flow

1. Error occurs in LLM provider/turn execution
2. Error is caught and logged: `tracing::error!()`
3. Error message displayed to user: `renderer.line(MessageStyle::Error, ...)`
4. Session state properly reset with `TurnLoopResult::Aborted`
5. Session continues: user can see error message in chat and continue interacting

### Testing

Build: `cargo build --release` ✓
Check: `cargo check` ✓
All checks pass without errors or warnings.

### Files Modified

- `/Users/vinhnguyenxuan/Developer/learn-by-doing/vtcode/src/agent/runloop/unified/turn/session_loop.rs`
  - Added imports for `TurnLoopOutcome` and `TurnLoopResult`
  - Added error handling for `run_turn_loop()`, `apply_turn_outcome()`, and `finalize_session()`
