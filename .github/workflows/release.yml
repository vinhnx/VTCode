name: Release

permissions:
    contents: write  # For creating GitHub releases
    id-token: write  # Required for trusted publishing (OIDC)

on:
    push:
        tags:
            - "v*"

jobs:
    release-and-publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            # Generate changelog and create GitHub release first (this analyzes git history)
            - name: Generate changelog and create GitHub release
              run: npx changelogithub --github vinhnx/vtcode
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # Set up Node.js for npm operations with proper registry configuration
            - name: Set up Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: lts/*
                  # Don't set registry-url here to avoid token requirement during setup
                  # We'll configure different registries during publishing steps

            # Ensure npm CLI version 11.5.1 or later for trusted publishing support
            - name: Update npm
              run: npm install -g npm@latest

            # Install project dependencies for npm package (if npm directory exists)
            # Note: We use --ignore-scripts to prevent postinstall from trying to download binaries
            # that haven't been built yet (binaries are built by the build-release.yml workflow)
            - name: Install npm dependencies
              run: |
                if [ -d "npm" ]; then
                  cd npm && npm ci --ignore-scripts
                else
                  echo "No npm directory found, skipping npm operations"
                fi

            # Run tests if they exist
            - name: Run tests
              run: |
                if [ -d "npm" ]; then
                  cd npm && npm test || echo "Tests failed or not present, continuing..."
                fi

            # Build the package if needed
            - name: Build package
              run: |
                if [ -d "npm" ]; then
                  cd npm && npm run build --if-present
                fi

            # npm publishing disabled - GitHub Actions builds cost money
            # Note: The npm package is deprecated. Install via:
            # - cargo install vtcode
            # - brew install vinhnx/tap/vtcode
            # - Download binaries from GitHub releases
            - name: npm publishing disabled
              if: false  # Always skip to avoid build costs
              run: |
                echo "npm publishing is disabled. Install VT Code via:"
                echo "  - cargo install vtcode (Rust)"
                echo "  - brew install vinhnx/tap/vtcode (macOS/Linux)"
                echo "  - Download from: https://github.com/vinhnx/vtcode/releases"

            # GitHub Packages publishing disabled - avoid npm-related builds
            - name: GitHub Packages publishing disabled
              if: false  # Always skip
              run: |
                echo "GitHub Packages publishing is disabled."
