name: Release

permissions:
    contents: write  # For creating GitHub releases
    id-token: write  # Required for trusted publishing (OIDC)

on:
    push:
        tags:
            - "v*"

jobs:
    release-and-publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            # Generate changelog and create GitHub release first (this analyzes git history)
            - name: Generate changelog and create GitHub release
              run: npx changelogithub --github vinhnx/vtcode
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # Set up Node.js for npm operations with proper registry configuration
            - name: Set up Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: lts/*
                  # Don't set registry-url here to avoid token requirement during setup
                  # We'll configure different registries during publishing steps

            # Ensure npm CLI version 11.5.1 or later for trusted publishing support
            - name: Update npm
              run: npm install -g npm@latest

            # Install project dependencies for npm package (if npm directory exists)
            # Note: We use --ignore-scripts to prevent postinstall from trying to download binaries
            # that haven't been built yet (binaries are built by the build-release.yml workflow)
            - name: Install npm dependencies
              run: |
                if [ -d "npm" ]; then
                  cd npm && npm ci --ignore-scripts
                else
                  echo "No npm directory found, skipping npm operations"
                fi

            # Run tests if they exist
            - name: Run tests
              run: |
                if [ -d "npm" ]; then
                  cd npm && npm test || echo "Tests failed or not present, continuing..."
                fi

            # Build the package if needed
            - name: Build package
              run: |
                if [ -d "npm" ]; then
                  cd npm && npm run build --if-present
                fi

            # Publish to npmjs.com (supports both trusted publishing and token-based auth)
            # Note: 
            # 1. We change the package name to vtcode-bin for npmjs.com since @vinhnx/vtcode is scoped
            # 2. If NPM_TOKEN secret is set, use it. Otherwise rely on trusted publishing (OIDC)
            # 3. We save the original package.json for the GitHub Packages step to restore
            - name: Publish to npmjs.com
              if: success() && startsWith(github.ref, 'refs/tags/v')
              env:
                NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: |
                if [ -d "npm" ]; then
                  cd npm
                  # Save original package.json for GitHub Packages step
                  cp package.json package-original.json
                  
                  # Create a temporary package.json with the npmjs.com package name (vtcode-bin)
                  if command -v jq >/dev/null 2>&1; then
                    jq '.name = "vtcode-bin" | del(.publishConfig)' package.json > package-npmjs.json
                    mv package-npmjs.json package.json
                    echo "Updated package name to vtcode-bin for npmjs.com publishing"
                  fi
                  
                  # Check if NPM_TOKEN is available for token-based auth
                  if [[ -n "${NODE_AUTH_TOKEN:-}" ]]; then
                    echo "Using npm token for authentication"
                    # Create .npmrc for token-based auth
                    echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
                  else
                    echo "No NPM_TOKEN found, attempting trusted publishing (OIDC)"
                  fi
                  
                  # Publish with ignore-scripts to prevent postinstall failures
                  npm publish --ignore-scripts
                else
                  echo "No npm directory found, skipping npm publishing"
                fi

            # Publish to GitHub Packages
            # Note: We need to configure npm to use GITHUB_TOKEN for GitHub Packages
            - name: Publish to GitHub Packages
              if: success() && startsWith(github.ref, 'refs/tags/v')
              run: |
                if [ -d "npm" ]; then
                  cd npm
                  # Restore the original package name for GitHub Packages (using backup since we're in detached HEAD)
                  if [ -f "package-original.json" ]; then
                    cp package-original.json package.json
                    rm package-original.json
                  fi
                  
                  # Configure npm to use GITHUB_TOKEN for GitHub Packages
                  echo "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}" > .npmrc
                  echo "@vinhnx:registry=https://npm.pkg.github.com" >> .npmrc
                  echo "Configuring GitHub Packages authentication"
                  
                  # Publish to GitHub Packages registry
                  npm publish --registry https://npm.pkg.github.com --ignore-scripts
                else
                  echo "No npm directory found, skipping GitHub Packages publishing"
                fi
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
