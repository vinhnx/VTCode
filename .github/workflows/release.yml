name: Release

permissions:
    contents: write  # For creating GitHub releases
    id-token: write  # Required for trusted publishing (OIDC)

on:
    push:
        tags:
            - "v*"

jobs:
    release-and-publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            # Generate changelog and create GitHub release first (this analyzes git history)
            - name: Generate changelog and create GitHub release
              run: npx changelogithub --github vinhnx/vtcode
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # Set up Node.js for npm operations with proper registry configuration
            - name: Set up Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: lts/*
                  # Don't set registry-url here to avoid token requirement during setup
                  # We'll configure different registries during publishing steps

            # Ensure npm CLI version 11.5.1 or later for trusted publishing support
            - name: Update npm
              run: npm install -g npm@latest

            # Install project dependencies for npm package (if npm directory exists)
            # Note: We use --ignore-scripts to prevent postinstall from trying to download binaries
            # that haven't been built yet (binaries are built by the build-release.yml workflow)
            - name: Install npm dependencies
              run: |
                if [ -d "npm" ]; then
                  cd npm && npm ci --ignore-scripts
                else
                  echo "No npm directory found, skipping npm operations"
                fi

            # Run tests if they exist
            - name: Run tests
              run: |
                if [ -d "npm" ]; then
                  cd npm && npm test || echo "Tests failed or not present, continuing..."
                fi

            # Build the package if needed
            - name: Build package
              run: |
                if [ -d "npm" ]; then
                  cd npm && npm run build --if-present
                fi

            # Publish to npmjs.com using trusted publishing (no token needed)
            # Note: We change the package name to vtcode-bin for npmjs.com since @vinhnx/vtcode is scoped
            - name: Publish to npmjs.com using trusted publishing
              if: success() && startsWith(github.ref, 'refs/tags/v')
              run: |
                if [ -d "npm" ]; then
                  cd npm
                  # Create a temporary package.json with the npmjs.com package name (vtcode-bin)
                  # This matches the logic in scripts/release.sh
                  if command -v jq >/dev/null 2>&1; then
                    jq '.name = "vtcode-bin" | del(.publishConfig)' package.json > package-npmjs.json
                    mv package-npmjs.json package.json
                    echo "Updated package name to vtcode-bin for npmjs.com publishing"
                  fi
                  # Publish using trusted publishing - npm will use OIDC tokens provided by GitHub Actions
                  npm publish --ignore-scripts
                else
                  echo "No npm directory found, skipping npm publishing"
                fi
              # No NODE_AUTH_TOKEN environment variable needed for trusted publishing

            # Publish to GitHub Packages using trusted publishing (no token needed in most cases)
            # Note: For GitHub Packages, we use the original scoped name @vinhnx/vtcode
            - name: Publish to GitHub Packages using trusted publishing
              if: success() && startsWith(github.ref, 'refs/tags/v')
              run: |
                if [ -d "npm" ]; then
                  cd npm
                  # Restore the original package name for GitHub Packages
                  git checkout package.json
                  # Publish to GitHub Packages registry using trusted publishing
                  npm publish --registry https://npm.pkg.github.com --ignore-scripts
                else
                  echo "No npm directory found, skipping GitHub Packages publishing"
                fi
              # GITHUB_TOKEN is available by default, but trusted publishing should work without explicit token in env
