name: tool-nextest-tools
permissions:
  contents: read

on:
  push:
    paths:
      - '**.rs'
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - '.github/workflows/**'
  pull_request:
    paths:
      - '**.rs'
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - '.github/workflows/**'

env:
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_TEST_DEBUG: 0
  RUSTFLAGS: "-D warnings"

# Time out jobs after 15 minutes to prevent resource waste
defaults:
  run:
    timeout-minutes: 15

jobs:
  tool-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install ripgrep (for grep_search)
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install nextest
        run: cargo install cargo-nextest --locked

      - name: Compile tests
        run: cargo test --locked --no-run

      - name: Build tests
        run: cargo nextest list -p vtcode-core --lib || true

      - name: Run tool-only tests (quarantined)
        run: |
          # Run the transform_matches_to_concise test from vtcode-core library
          cargo nextest run -p vtcode-core --lib -E "test(tools::search::tests::test_transform_matches_to_concise)"
          # Run the anthropic API key test from vtcode-core library
          cargo nextest run -p vtcode-core --lib -E "test(config::api_keys::tests::test_get_anthropic_api_key_from_env)"
