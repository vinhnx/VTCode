# `vtcode-bash-runner`

`vtcode-bash-runner` exposes the safe shell helpers that originally lived in
VTCode's TUI runtime as a reusable crate. It focuses on ergonomic
filesystem and search operations (`cd`, `ls`, `mkdir`, `rm`, `cp`, `mv`,
`grep`) and wraps them with workspace-aware safety checks so downstream
projects can script workspaces without accidentally escaping the configured
root.

## Core Concepts

- **`BashRunner`** – high-level helper with path resolution, workspace
  validation, and command builders that emit platform-specific shell syntax.
- **`CommandExecutor`** – pluggable backend responsible for executing the
  resolved shell command. The default `ProcessCommandExecutor` relies on
  `std::process`, but consumers can swap in remote or in-memory adapters.
- **`CommandPolicy`** – guard interface that validates invocations before
  execution. The crate includes a permissive `AllowAllPolicy` and a
  workspace-aware `WorkspaceGuardPolicy`.

These building blocks live under `vtcode-bash-runner::runner`,
`vtcode-bash-runner::executor`, and `vtcode-bash-runner::policy`
respectively and are re-exported from the crate root for convenience.

## Shell Selection and Portability

`BashRunner` determines the default `ShellKind` at runtime. Unix targets use
`sh -c` while Windows targets emit PowerShell commands (e.g.
`Get-ChildItem`, `New-Item`). Each command helper sanitizes paths and
patterns (via [`shell_escape`](https://docs.rs/shell-escape)) so
user-provided strings cannot break out of quoting contexts.【F:vtcode-bash-runner/src/runner.rs†L1-L229】【F:vtcode-bash-runner/src/runner.rs†L344-L372】

Because execution is delegated through the `CommandExecutor` trait,
downstream crates can support additional shell families or simulation modes
without modifying the runner logic.【F:vtcode-bash-runner/src/executor.rs†L1-L110】

## Policy Hooks

Policies run before every command execution and receive the
`CommandInvocation` with shell family, command string, working directory,
and the set of touched paths. `WorkspaceGuardPolicy` ensures invocations and
paths stay within a configured `WorkspacePaths` root and optionally enforces
an allowlist of permitted command categories.【F:vtcode-bash-runner/src/policy.rs†L1-L73】

This separation lets applications plug in auditing, logging, or approval
workflows while retaining the same runner API.

## Dry-Run and Testing Example

The crate ships with an example that demonstrates how to implement a custom
`CommandExecutor` for dry-run logging. It records the commands generated by
`BashRunner`, returns synthetic output for `ls`, and prints each invocation
so CI environments can validate command construction without shell access.

```shell
cargo run -p vtcode-bash-runner --example dry_run
```

The example uses `tempfile` to create an isolated workspace and shows how to
inspect the captured invocations and outputs.【F:vtcode-bash-runner/examples/dry_run.rs†L1-L55】

## Next Steps

- Expand the command surface with additional helpers (`stat`, `find`,
  `run`) before publishing a 1.0 release.
- Add optional executors (pure Rust, remote RPC) and feature flags matching
the original extraction strategy.
- Backfill integration docs illustrating how VTCode's TUI wires
`WorkspaceGuardPolicy` with the shared `WorkspacePaths` trait for
application-level security.
